<!DOCTYPE >
<html>
  <head>
    <link href="style/style.css" rel="stylesheet" />
    <link href="style/nouislider.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.0/nouislider.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://unpkg.com/mathjs@7.2.0/dist/math.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="script/Oscillator.js"></script>
    <script src="script/controlpanel.js"></script>
    <script src="script/plot.js"></script>
  </head>
  <body>
    <div id="plotlyplot"></div>
    <div id="controlpanel-container">
      <div id="plot-controlpanel" class="controlpanel">
        <div id="plottype" class="radiobutton">
          <input
            type="radio"
            id="plottype1"
            name="plottype"
            value="Linear"
            checked="true"
          />
          <label for="plottype1">Linear</label>
          <input type="radio" id="plottype2" name="plottype" value="Ternary" />
          <label for="plottype2">Ternary</label>
        </div>

        <div class="slider-assembly">
          <button
            id="nsteps_button"
            class="slider-button"
            type="button"
            style="display: none"
          ></button>
          <div id="nsteps_label" class="slider-label"></div>
          <div id="nsteps_slider" class="slider"></div>
          <div id="nsteps_inputs" class="slider-inputs"></div>
        </div>
      </div>
      <!-- End experimental parameters control panel. -->

      <div id="experiment-controlpanel" class="controlpanel">
        <div id="nutype" class="radiobutton">
          <input type="radio" id="nutype1" name="nutype" value="0" />
          <label id="nutype1-label" for="nutype1">&nu;<sub>e</sub></label>
          <input
            type="radio"
            id="nutype2"
            name="nutype"
            value="1"
            checked="true"
          />
          <label id="nutype2-label" for="nutype2">&nu;<sub>&mu;</sub></label>
          <input type="radio" id="nutype3" name="nutype" value="2" />
          <label id="nutype3-label" for="nutype3">&nu;<sub>&tau;</sub></label>
        </div>

        <div id="chirality" class="radiobutton">
          <input
            type="radio"
            id="chirality1"
            name="chirality"
            value="1"
            checked="true"
          />
          <label for="chirality1">Neutrino</label>
          <input type="radio" id="chirality2" name="chirality" value="-1" />
          <label for="chirality2">Antineutrino</label>
        </div>

        <div class="slider-assembly">
          <button id="L_button" class="slider-button" type="button"></button>
          <div id="L_label" class="slider-label"></div>
          <div id="L_slider" class="slider"></div>
          <div id="L_inputs" class="slider-inputs"></div>
        </div>

        <div class="slider-assembly">
          <button id="E_button" class="slider-button" type="button"></button>
          <div id="E_label" class="slider-label"></div>
          <div id="E_slider" class="slider"></div>
          <div id="E_inputs" class="slider-inputs"></div>
        </div>

        <div class="slider-assembly">
          <button id="rho_button" class="slider-button" type="button"></button>
          <div id="rho_label" class="slider-label"></div>
          <div id="rho_slider" class="slider"></div>
          <div id="rho_inputs" class="slider-inputs"></div>
        </div>
      </div>
      <!-- End experimental parameters control panel. -->

      <div id="mixing-controlpanel" class="controlpanel">
        <div class="slider-assembly">
          <button id="th12_button" class="slider-button" type="button"></button>
          <div id="th12_label" class="slider-label"></div>
          <div id="th12_slider" class="slider"></div>
          <div id="th12_inputs" class="slider-inputs"></div>
        </div>

        <div class="slider-assembly">
          <button id="th23_button" class="slider-button" type="button"></button>
          <div id="th23_label" class="slider-label"></div>
          <div id="th23_slider" class="slider"></div>
          <div id="th23_inputs" class="slider-inputs"></div>
        </div>

        <div class="slider-assembly">
          <button id="th13_button" class="slider-button" type="button"></button>
          <div id="th13_label" class="slider-label"></div>
          <div id="th13_slider" class="slider"></div>
          <div id="th13_inputs" class="slider-inputs"></div>
        </div>

        <div class="slider-assembly">
          <button
            id="Dm21sq_button"
            class="slider-button"
            type="button"
          ></button>
          <div id="Dm21sq_label" class="slider-label"></div>
          <div id="Dm21sq_slider" class="slider"></div>
          <div id="Dm21sq_inputs" class="slider-inputs"></div>
        </div>

        <div class="slider-assembly">
          <button
            id="Dm31sq_button"
            class="slider-button"
            type="button"
          ></button>
          <div id="Dm31sq_label" class="slider-label"></div>
          <div id="Dm31sq_slider" class="slider"></div>
          <div id="Dm31sq_inputs" class="slider-inputs"></div>
        </div>

        <div class="slider-assembly">
          <button id="dCP_button" class="slider-button" type="button"></button>
          <div id="dCP_label" class="slider-label"></div>
          <div id="dCP_slider" class="slider"></div>
          <div id="dCP_inputs" class="slider-inputs"></div>
        </div>
      </div>
      <!-- End mixing parameters control panel. -->
    </div>
    <!-- End control panel container. -->
    <div id="buttond">
      <button id="downloadbutton" type="button">Download CSV</button>
    </div>
  </body>
</html>

<script>

  // Get neutrino oscillation parameter objects.
  let pars = makeParMap();
  let mat = new Matrices(pars);

  // Second parameter map to avoid double updating on same parameters.
  // (Nu set to invalid value for first update.)
  let drawnPars = _.cloneDeep(pars);
  drawnPars["nu"] = -1;

  // Arrays to store oscillation results.
  let xValues = [];
  let yValues = [];

  // Handle input from radio buttons.
  // Plot type.
  let ptbuttons = document.getElementsByName("plottype");
  let ptype = document.querySelector('input[name="plottype"]:checked').value;
  for (let i = 0; i < ptbuttons.length; ++i) {
    ptbuttons[i].onclick = function () {
      ptype = this.value;
      createPlot("plotlyplot", ptype, pars, xValues, yValues);
    };
  }
  // Neutrino flavour.
  let ntbuttons = document.getElementsByName("nutype");
  for (let i = 0; i < ntbuttons.length; ++i) {
    ntbuttons[i].onclick = function () {
      pars.nu.val = this.value;
      updateGraph("nu");
    };
  }
  // Neutrino chirality.
  let chbuttons = document.getElementsByName("chirality");
  for (let i = 0; i < chbuttons.length; ++i) {
    chbuttons[i].onclick = function () {
      pars.anti.val = this.value;
      // Recreate plot to update axis and trace labels.
      createPlot("plotlyplot", ptype, pars, xValues, yValues);
      // Recreate radio button labels.
      const nustring = pars.anti.val > 0 ? "&nu;" : "&nu;&#773;";
      document.getElementById("nutype1-label").innerHTML = nustring+"<sub>e</sub>";
      document.getElementById("nutype2-label").innerHTML = nustring+"<sub>&mu;</sub>";
      document.getElementById("nutype3-label").innerHTML = nustring+"<sub>&tau;</sub>";

      updateGraph("anti");
    };
  }

  // Render the ternary plot using plotly.
  createPlot("plotlyplot", ptype, pars, xValues, yValues);

  function generateData(pars, id = "", use_exp = false) {
    // Find the array in the parameter map. Needs one guaranteed array in pars.
    const rangekeys = Object.keys(pars).filter((key) =>
      Array.isArray(pars[key].val)
    );
    // If more than one or no arrays found in parameter map, do nothing.
    if (rangekeys.length != 1) return undefined;
    const thisArrID = rangekeys[0];
    let thisArr = pars[thisArrID].val;

    // Changed/range variable is a mixing parameter.
    const mixingpars = ["anti", "th12", "th23", "th13", "Dm21sq", "Dm31sq", "dCP", "rho"];
    const changedVarIsMixingPar = mixingpars.indexOf(id) != undefined;
    const rangeVarIsMixingPar = mixingpars.indexOf(thisArrID) != undefined;
    // Only update mixing matrices once if changed variable is mixing parameter.
    if (changedVarIsMixingPar && !rangeVarIsMixingPar) {
      mat = new Matrices(pars);
    }

    // Get x range and reset y values.
    const xv = math
      .range(
        thisArr[0],
        thisArr[1],
        (thisArr[1] - thisArr[0]) / pars.nsteps.val,
        true
      )
      .toArray();
    let yv = [];

    // Use a temporary non-range parameter map to get oscillation results.
    let tmppars = _.cloneDeep(pars);
    for (let x of xv) {
      tmppars[thisArrID].val = x;
      if (rangeVarIsMixingPar) {
        mat.update(tmppars);
      }
      yv.push(oscillate(tmppars, mat, use_exp));
    }
    yv = math.transpose(yv);

    return [xv, yv];
  }

  // Function to update the data in the graph.
  function updateGraph(id = "") {
    // Check if the new parameters are different from those already drawn.
    // If they're not equal, set them to be equal and proceed with processing.
    if (_.isEqual(pars, drawnPars)) {
      return;
    } else {
      drawnPars = _.cloneDeep(pars);
    }

    // Get new data.
    const newdata = generateData(pars, id);
    if (newdata == undefined) {
      return;
    }
    [xValues, yValues] = newdata;

    // Update plot data.
    if (ptype == "Ternary") {
      Plotly.restyle("plotlyplot", {
        a: [yValues[0]],
        b: [yValues[1]],
        c: [yValues[2]],
      });
    } else if (ptype == "Linear") {
      Plotly.restyle(
        "plotlyplot",
        {
          x: [xValues],
          y: [yValues[0], yValues[1], yValues[2]],
        },
        [0, 1, 2]
      );
      // linlayout.xaxis.title.text = pars[thisArrID].label;
    }
  }

  var updateSliders = true; // Update guard.
  function addListeners(slider_arr, id = "") {
    // Check for changes in sliders. Change parameters
    slider_arr.forEach(function (slider) {
      // Determine snap range in value units.
      const srange = slider.noUiSlider.options.range;
      const snapfrac = 0.02; // Snap range as fraction of slider range.
      const snaprange = (srange["max"] - srange["min"]) * snapfrac;

      slider.noUiSlider.on("update", function (valuestrings) {
        if (!updateSliders) return;
        // Convert slider value(s) to numbers.
        var vals = valuestrings.map(Number);
        const key = slider.id.substr(0, slider.id.indexOf("_"));

        // Slider snapping.
        vals.forEach(function (v, i) {
          pars[key].snaps.forEach(function (snapval) {
            if (math.abs(v - snapval) < snaprange) {
              vals[i] = snapval;
              var tmpvals = [null, null];
              tmpvals[i] = snapval;
              // Use update guard to avoid update on set causing infinite loop.
              updateSliders = false;
              slider.noUiSlider.set(tmpvals, false, false);
              updateSliders = true;
            }
          });
        });

        // Change parameter map to reflect slider.
        vals.length == 1 ? (pars[key].val = vals[0]) : (pars[key].val = vals);

        updateGraph(key);
      });
    });
  }

  // Add listeners for buttons and set up sliders.
  var ids = [
    "nsteps",
    "L",
    "E",
    "rho",
    "th12",
    "th23",
    "th13",
    "Dm21sq",
    "Dm31sq",
    "dCP",
  ];
  // Set up control panel.
  const controlp = document.getElementById("controlp");
  var sliders = [];
  ids.forEach(function (id) {
    // Set up slider in control panel.
    sliders.push(addRow(id, pars[id]));
    // Add listeners for buttons.
    var bd = document.getElementById(id + "_button");
    bd.addEventListener("click", function () {
      makeRange(sliders, id);
      addListeners(sliders, id);
      if (ptype == "Linear") {
        Plotly.relayout("plotlyplot", {
          "xaxis.title.text": pars[id].label,
        });
      }
    });
  });

  addListeners(sliders);

  // Function to convert the nu arrays to a csv format.
  function dataToCsv(x, y, p) {
    // Header. First, find range parameter in parameter set.
    var arrP = "";
    for (const [key, par] of Object.entries(p)) {
      if (Array.isArray(par.val)) {
        arrP = key;
        break;
      }
    }
    // Do nothing if no range was found.
    if (arrP == "") return;

    // Add headers and concatenate arrays.
    data = [
      [pars[arrP].label, "nu_e", "nu_mu", "nu_tau"],
      ...math.transpose([x, ...y]),
    ];

    // Cast into csv format.
    return data
      .map(function (row) {
        return row.join(",");
      })
      .join("\n");
  }

  // Download button functionality.
  var saveData = (function () {
    var a = document.createElement("a");
    document.body.appendChild(a);
    a.style = "display: none";
    return function (xValues, yValues, pars, fileName) {
      // Generate new data based on the more expensive and accurate exponential algorithm.
      const expdata = generateData(pars, "", true);
      var csv =
        expdata == undefined
          ? dataToCsv(xValues, yValues, pars)
          : dataToCsv(...expdata, pars);
      var blob = new Blob([csv], { type: "octet/stream" });
      var url = window.URL.createObjectURL(blob);
      a.href = url;
      a.download = fileName;
      a.click();
      window.URL.revokeObjectURL(url);
    };
  })();

  var dbutton = document.getElementById("downloadbutton");
  dbutton.addEventListener("click", function () {
    var fileName = "nu.csv";

    saveData(xValues, yValues, pars, fileName);
  });
</script>
